// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum ScanResult {
  success
  already_used
  invalid
  not_found
  wrong_event
  not_paid
}

enum EventCategory {
  day
  speaker
  distribution
}

model User {
  id        String  @id @default(uuid()) @db.Uuid
  convexId  String? @unique @map("convex_id")
  email     String
  name      String
  phone     String?
  college   String?
  createdAt BigInt  @map("created_at")

  orders Order[]

  @@map("users")
}

model Event {
  id          String  @id @default(uuid()) @db.Uuid
  convexId    String? @unique @map("convex_id")
  name        String
  description String
  date        BigInt
  venue       String
  capacity    Int
  price       Int
  isActive    Boolean @map("is_active")
  accessToken String? @unique @map("access_token")
  category    EventCategory @default(day)
  sourceEventCode Int? @unique @map("source_event_code")
  scanOrder   Int @default(0) @map("scan_order")
  createdAt   BigInt  @map("created_at")

  orders   Order[]
  scanLogs ScanLog[]
  gates    Gate[]

  @@index([isActive])
  @@index([date])
  @@index([scanOrder])
  @@map("events")
}

model Order {
  id            String        @id @default(uuid()) @db.Uuid
  convexId      String?       @unique @map("convex_id")
  orderId       String        @unique @map("order_id")
  receiptId     String?       @map("receipt_id")
  productMeta   String?       @map("product_meta")
  invoiceNumber String?       @map("invoice_number")
  sourceEventCode Int?        @map("source_event_code")
  registrationId Int?         @map("registration_id")
  fieldValues   Json?         @map("field_values")
  accessTokens  String[]      @default([]) @map("access_tokens")
  tshirtEligible Boolean      @default(false) @map("tshirt_eligible")
  tshirtSize    String?       @map("tshirt_size")
  tshirtColor   String?       @map("tshirt_color")
  userId        String        @map("user_id") @db.Uuid
  eventId       String        @map("event_id") @db.Uuid
  quantity      Int
  totalAmount   Int           @map("total_amount")
  paymentStatus PaymentStatus @map("payment_status")
  checkedIn     Boolean       @map("checked_in")
  checkedInAt   BigInt?       @map("checked_in_at")
  checkedInBy   String?       @map("checked_in_by")
  checkedInGate String?       @map("checked_in_gate")
  mailed        Boolean       @default(false)
  createdAt     BigInt        @map("created_at")
  updatedAt     BigInt        @map("updated_at")

  user     User      @relation(fields: [userId], references: [id])
  event    Event     @relation(fields: [eventId], references: [id])
  scanLogs ScanLog[]

  @@index([eventId])
  @@index([userId])
  @@index([eventId, checkedIn])
  @@index([receiptId])
  @@index([invoiceNumber])
  @@index([registrationId])
  @@index([accessTokens], type: Gin)
  @@map("orders")
}

model ScanLog {
  id         String     @id @default(uuid()) @db.Uuid
  convexId   String?    @unique @map("convex_id")
  orderId    String     @map("order_id")
  eventId    String     @map("event_id") @db.Uuid
  scanResult ScanResult @map("scan_result")
  scannedBy  String     @map("scanned_by")
  gate       String
  ipAddress  String?    @map("ip_address")
  userAgent  String?    @map("user_agent")
  timestamp  BigInt

  order Order @relation(fields: [orderId], references: [orderId])
  event Event @relation(fields: [eventId], references: [id])

  @@index([orderId])
  @@index([eventId])
  @@map("scan_logs")
}

model Gate {
  id        String  @id @default(uuid()) @db.Uuid
  convexId  String? @unique @map("convex_id")
  gateId    String  @unique @map("gate_id")
  name      String
  eventId   String  @map("event_id") @db.Uuid
  isActive  Boolean @map("is_active")
  createdAt BigInt  @map("created_at")

  event Event @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@map("gates")
}
